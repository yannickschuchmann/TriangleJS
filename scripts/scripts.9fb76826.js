"use strict";angular.module("triangleJsApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngTouch"]),angular.module("triangleJsApp").controller("MainCtrl",function(){}),angular.module("triangleJsApp").controller("ControlsCtrl",["$scope","$rootScope","verticesService","settingsService",function(a,b,c,d){a.randomAmount=50,a.settings=d.get(),a["export"]=function(){b.$broadcast("export")},a.clear=function(){c.removeAllVertices(),b.$broadcast("render")},a.undo=function(){c.removeLastVertex(),b.$broadcast("render")},a.addRandom=function(){for(var a=d.get("width"),e=d.get("height"),f=0;f<this.randomAmount;f++){var g=[~~(Math.random()*a),~~(Math.random()*e)];c.addVertex(g)}b.$broadcast("render")},a.updateSettings=function(){d.set(a.settings)}}]),angular.module("triangleJsApp").directive("renderer",["verticesService","settingsService",function(a,b){var c,d,e,f,g,h=function(a){c=document.getElementById("image"),d=c.getContext("2d"),e=document.getElementById("polygon"),f=e.getContext("2d"),a.find("img").on("load",function(){e.width=c.width=this.width,e.height=c.height=this.height,b.set({width:this.width,height:this.height}),d.drawImage(this,0,0),angular.element(this).css("display","none")}),g=b.get(),i()},i=function(){e.addEventListener("mousedown",j,!1)},j=function(b){b.preventDefault(),a.addVertex(k(b)),l()},k=function(a){for(var b=0,c=0,d=e;d;)b+=d.offsetLeft-d.scrollLeft+d.clientLeft,c+=d.offsetTop-d.scrollTop+d.clientTop,d=d.offsetParent;return[a.x-b,a.y-c]},l=function(c){var d=c||f;d.clearRect(0,0,e.width,e.height);var h=a.getTriangles();return g=b.get(),h.forEach(function(a){var b=a.vertices[0],c=a.vertices[1],e=a.vertices[2];d.fillStyle=m(a.getCenterVertex()),d.beginPath(),d.moveTo(b[0],b[1]),d.lineTo(c[0],c[1]),d.lineTo(e[0],e[1]),d.closePath(),d.fill()}),d},m=function(a){var b,e,f=b=0,h=a,i=g.colorRange,j=i/2,k=[0,0,0];f=h[0]<j?0:h[0]+j>c.width?c.width-j:h[0]-j,b=h[1]<j?0:h[1]+j>c.height?c.height-j:h[1]-j,f=~~f,b=~~b,e=d.getImageData(f,b,i,i).data;for(var l=0;l<Math.pow(i,2);l++)k[0]+=e[4*l],k[1]+=e[4*l+1],k[2]+=e[4*l+2];return"rgb("+~~(k[0]/l)+","+~~(k[1]/l)+","+~~(k[2]/l)+")"},n=function(){var a=new C2S(b.get("width"),b.get("height"));a=l(a),open("data:image/svg+xml,"+encodeURIComponent(a.getSerializedSvg()))};return{templateUrl:"scripts/directives/renderer.html",restrict:"E",link:function(a,c){h(c),a.$on("export",function(){n()}),a.$on("render",function(){l()}),a.$watch(function(){return b.get()},function(){l()},!0)}}}]),angular.module("triangleJsApp").service("verticesService",function(){function a(a){this.vertices=a,this.getCenterVertex=function(){var a,b=a=0,c=this.vertices.length;return this.vertices.forEach(function(c){a+=c[0],b+=c[1]}),[~~(a/c),~~(b/c)]}}var b=[];this.getTriangles=function(){for(var c,d=[],e=Delaunay.triangulate(b),f=0;f<e.length;f){c=e.slice(f,f+3);for(var g=0;g<c.length;g++){var h=c[g];c[g]=[b[h][0],b[h][1]]}d.push(new a(c)),f+=3}return d},this.addVertex=function(a){b.push(a)},this.removeLastVertex=function(){b.splice(-1)},this.removeAllVertices=function(){b=[]}}),angular.module("triangleJsApp").service("settingsService",["$rootScope",function(){this._settings={colorRange:6},this.get=function(a){return a?this._settings[a]:this._settings},this.set=function(a){angular.extend(this._settings,a),a.colorRange=parseInt(a.colorRange)}}]);